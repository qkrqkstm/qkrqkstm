---

- hosts: all
  become: yes
  become_user: root
  become_method: sudo

  tasks:

    - name: configure firewall access to well known services.
      notify:
        - restart firewalld
        - wait for SSH port coming up
      when: ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7 and location == 'nbp'
      firewalld: permanent=true zone=public state=enabled rich_rule="rule family=ipv4 source address={{ item.address }} service name={{ item.service }} accept"
      with_items:
        - { address: "1.214.220.9", service: "ssh" }
        - { address: "1.214.220.10", service: "ssh" }

    - name: configure firewall reject ssh from anywhere.
      notify:
        - restart firewalld
        - wait for SSH port coming up
      when: ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7 and location == 'nbp'
      firewalld: permanent=true zone=public state=disabled service=ssh

  handlers:

    - name: restart firewalld
      service: name=firewalld state=restarted enabled=yes

    - name: wait for SSH port coming up
      wait_for: host={{ ansible_ssh_host }} port=22 delay=10 search_regex=OpenSSH
