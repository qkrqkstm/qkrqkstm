---

- hosts: maria10.3
  become: yes
  become_user: root
  become_method: sudo
  vars_files:
    - '{{ inventory_dir }}/vars/{{ project }}_maria.yml'

  tasks:

    - name: Alias setting for MariaDB operation
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      copy: src={{ inventory_dir }}/files/maria/bash_profile dest=/root/.bash_profile owner=root group=root mode=0644

    - name: install required package
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int == 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      yum: name=MySQL-python state=present

    - name: install required package
      when: ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 8
      yum: name=python3-PyMySQL state=present

    - name: create maria repo file
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      template: src={{ inventory_dir }}/templates/maria/MariaDB.repo.j2 dest=/etc/yum.repos.d/MariaDB.repo owner=root group=root mode=0644

    - name: install MariaDB
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      yum: name="MariaDB-server" enablerepo=mariadb10.3 state=present

    - name: ansible flag check
      stat: path=/etc/runonce.flg
      register: r_flg

    - name: Install my.cnf template
      copy: src={{ inventory_dir }}/files/maria/my-10.3.cnf dest=/etc/my.cnf owner=root group=root mode=0644
      when:
        - (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
        - not r_flg.stat.exists

    - name: Create ansible-flag file
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      file: path=/etc/runonce.flg state=touch mode="0644"

    - name: my.cnf.d deleted
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      file: path=/etc/my.cnf.d state=absent

    - name: Create log directory
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      notify:
        - restart MariaDB
        - delete anonymous user
        - delete root user which is not needed
        - change password of root user
      file: path=/var/log/mysql state=directory owner=mysql group=mysql mode=0755

  handlers:

    - name: restart MariaDB
      when: (ansible_distribution == 'CentOS' and ansible_distribution_major_version|int >= 7) or (ansible_distribution == "Amazon" and ansible_distribution_version == "2")
      service: name=mariadb state=restarted enabled=yes

    - name: delete anonymous user
      mysql_user:
        name: ""
        host_all: yes
        state: absent
        login_host: "127.0.0.1"

    - name: delete root user which is not needed
      mysql_user:
        name: "root"
        host: "{{ item }}"
        state: absent
        login_host: "127.0.0.1"
      with_items:
        - ::1
        - "{{ inventory_hostname }}"
        - "{{ ansible_hostname }}"

    - name: change password of root user
      mysql_user:
        name: "root"
        host: "{{ item }}"
        password: "{{ mariadb_default_root_password }}"
        encrypted: yes
        login_host: "127.0.0.1"
      with_items:
        - localhost
        - 127.0.0.1
